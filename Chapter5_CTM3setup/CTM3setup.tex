\setcounter{chapter}{4}
\chapter{Alteration made in the Oslo CTM3}

This chapter describes the setup and altered modules of the Oslo CTM3. The model is run with a supercomputer, which at the beginning of my master thesis was Abel (\cite{abel}). In January 2020, Abel was shut down and the Oslo CTM3 migrated to Saga (\cite{saga}). 

\medskip

When testing, a degraded resolution was used in the CTM3. In the \texttt{Makefile} it is possible to degrade the horizontal resolution by combining several boxes into one. The setting used for testing was \texttt{HWINDOW=HFOUR}, i.e. a combination of four native boxes and thus a $4.5^o \times 4.5^o$ resolution. 



\section{The Supercomputer}

\subsection{The Job File}

The job file is used to set up a run. The job file declares the job name, the input file, the project number and the wall clock limit, i.e. the max running time in the super computer and the number of nodes to use on the supercomputer when running the simulation. Also, it contains the path to the restart files (information about restart files can be found in Section \ref{subsec:restart_files}).

\subsubsection{Abel vs. Saga}

As the Oslo CTM3 was not optimized for Saga, the job file setup at Saga and Abel differed slightly. At Abel, the most efficient setup was the following: 

\begin{lstlisting}
#!/bin/bash
# Script for running on Abel.
# --------------------------------------------------------------------------
# Job name (enter your distinct job name):
#SBATCH --job-name=C3RUN_almost_BE
#
# Project (enter your noturn project number):
#SBATCH --account=geofag
#
# Wall clock limit (setting for one year 96:0:0):
#SBATCH --time=0:30:0
#
# Does your job exceed one week, use "--partition=long":
# ####SBATCH --partition=long
#
# Max memory usage:
#SBATCH --mem-per-cpu=3000M
#
# Number of cores:
#SBATCH --ntasks-per-node=16
#
# Number of nodes:
#SBATCH --nodes=1
#
#
## Set up job environment
source /cluster/bin/jobsetup
\end{lstlisting}

The number of nodes had to be different at Saga as it was slowed down by an increased number: 

\begin{lstlisting}
#!/bin/bash
# Script for running on Saga.
# --------------------------------------------------------------------------
# Job name (enter your distinct job name):
#SBATCH --job-name=C3RUN_BE_PI_HFOUR_MarchMay_2013
#
# Project (enter your noturn project number):
#SBATCH --account=nn9188k
#
# Wall clock limit (setting for one year 96:0:0):
#SBATCH --time=15:0:0
#
# Does your job exceed one week, use "--partition=long":
# ####SBATCH --partition=long
#
# Max memory usage:
#SBATCH --mem-per-cpu=3000M
#
# Number of cores:
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=8
#
# Number of nodes:
#SBATCH --nodes=1
#
#
## Set up job environment:
#set -o errexit  # Exit the script on any error
set -o nounset  # Treat any unset variables as an error
\end{lstlisting}


\subsection{The Input File}

The input file consists of three parts, one that sets up the meteorological year, start day and end day. The second part lists some of the input file names, including the tracer lists. Information of the tracer list used here can be found in Section \ref{subsubsec:Ltracer_list} and \ref{subsubsec:tracer_list}. The third part covers information about the diagnostics. 

In order to save CPU time and avoid conflicts regarding the use of stratospheric methyl bromide ($\chem{CH_3Br}$) as a designated species for $\chem{CHBr_3}$ and $\chem{CH_2Br_2}$ (explained further in Section \ref{sec:oceanic_emissions}), the stratosphere was turned off. Oppskrifta ligger i \ref{app:turning_off_the_stratosphere}

SKriv om Pre-industrial setup \ref{app:PI_run}


\section{Wet deposition - \texttt{scavenging\_wet.inp}}\label{sec:scav_wet}

Wet scavenging rates for \chem{HCl}, \chem{HBr}, $\chem{BrONO_2}$ and $\chem{ClONO_2}$ were added to the wet deposition input table \texttt{scavenging\_wet.inp}. The Henry's law constants are listed in Table \ref{tab:Henrys_law}. 

\input{Chapter5_CTM3setup/henrys_law}




\section{Restart files}\label{subsec:restart_files}


The restart file is a NetCDF file that contains the tracer distribution and moments for all species in a simulation. For the transported species, it has prefix \texttt{STT}, and \texttt{XSTT} for the non-transported species. The transported species are associated with their moments, which has the prefixes \texttt{SUT}, \texttt{SVT}, \texttt{SWT}, \texttt{SUU}, \texttt{SVV}, \texttt{SWW}, \texttt{SUV}, \texttt{SUW}, \texttt{SVW} (\cite{SovdeManual}). The restart file is used as an initial field for the production run, which requires a spin up, and it is therefore necessary to determine the length of the spin up (in model time) according to the lifetime of the chemical species of interest. 

\medskip

Restart files used in \cite{Falk_2019} was provided by Stefanie (\texttt{ctm3\_restart\_20010101.nc}) and used for my own spin-up. The provided restart file was spun-up over a 10 years transient run starting in 1990. It was necessary to make new restart files, as the code is changed and the stratosphere is turned off, which alters the chemistry. The restart files were thus based on the same emission inventory (MEGAN and CEDS17) except for biomass burning which was taken from CEDS17 instead of GFed. The reason for this is that the GFed files only exist until 2005, and my intent was to run the model in later years as well. 

\medskip


The dry-deposition scheme also differs, where I have used the old dry-deposition scheme instead of the mOSaic scheme (for more information, see \cite{Falk_2019} and references therein). The main difference between the dry-deposition schemes is that the dry deposition rate in the old scheme is lower over ice and snow surfaces, leading to a general overestimation of $\chem{O_3}$.


\medskip

The spin-up time is the time it takes for the simulated surface concentrations to be unaffected by initial conditions. \cite{Curci_AirPollution} found that the optimal model spin-up time in terms of ozone was 9 days. Although this study was based on a domain in the GEOS-Chem global model and a regional model, and had a different set-up than the Oslo CTM3, this estimate is applicable to my own spin-up. It also stated by \cite{SeinfeldSpyros} that the global mean lifetime of tropospheric ozone is 19 days. In order to be sure that the chemistry is indeed spun up properly, the restart files were ran for 3 months. 

\subsection{Pre-industrial and present-day restart files}\label{sec:PI_and_PD_restart}

The pre-industrial and present-day restart files were made without moving the tracers \chem{Br}. \chem{BrO} and \chem{Cl} to transported species (for information about moving species from non-transported to transported, see Section \ref{subsubsec:tracer_list}). This became the solution to the problem that the original versions of the CTM3 (i.e. unaltered except for turning off the stratosphere in both cases and downscaling of the methane field in the case of the \acrshort{pi}-runs) had problems running. As there is no handling of these non-transported tracers in the troposphere in these branches. 
 
\section{Ltracer list - \texttt{Ltracer\_emis\_ceds17\_YEAR\_megan.d}}\label{subsubsec:Ltracer_list}

The tracer list contains all the emission information that the model needs to be able to run. The emission inventory used in this thesis is the \acrlong{ceds} inventory and the \acrlong{megan}, version 2.10, inventory. 

\medskip

\acrshort{ceds} is a historical emission inventory for anthropogenic aerosol and precursor compounds (\cite{Lund2018}). The historical emissions are only available for the 1750-2014 period, which limits the possibilities for simulations after 2014 in this thesis. 

\medskip

\acrshort{megan} v2.10 is a framework used by the model to estimate biogenic fluxes between terrestrial ecosystems and the atmosphere (\cite{Guenther2012}). 


\section{Implementation of halogen chemistry}

In essence, three modules were changed to implement the halogen chemistry. They were \texttt{pchemc\_ij.f90}, \texttt{tropchem\_oslo.f90} and \texttt{chem\_oslo\_rates.f90}. The base for the scripting is the work performed by \cite{Susanne}, which I have continued to alter.  The reactions that were implemented in the various modules can be seen in Table \ref{tab:3}.


%Some of the problems that occurred during this process, how these were tested and attemptedly solved, can be seen in Section \ref{chap:problem_solving}.
\input{Chapter5_CTM3setup/reactions_implemented}


\subsection{Changes in \texttt{pchemc\_ij.f90}:}

\texttt{pchem\_ij} is a module that functions as a column driver for the Oslo tropospheric chemistry. It has one subroutine, \texttt{OSLO\_CHEM}, which integrates the Oslo Chemistry in the troposphere using the QSSA method (see Section \ref{sec:QSSA}). The model loops from the bottom layer to the top layer of the troposphere (\texttt{LMTROP}, \texttt{LM} = total number of layers, \texttt{TROP} = troposphere). 

\subsubsection{Photolysis- and chemical reaction rates}

The phytolysis- and chemical reaction rates were set at the very beginning of the loop of the tropospheric column. As the oceanic source of $\chem{CHBr_3}$ and $\chem{CH_2Br_2}$ (see Section \ref{sec:impl_ocean_source}) and multiphase reactions (see Section \ref{sec:impl_multiphase_react}) only apply at the surface, this was declared at the beginning:

\begin{lstlisting}
!// Adding a bromine (CHBr3 and CH2Br2) source 
!// and heterogeneous reaction rate 
!// to the first level of the atmosphere
sea_multi = 1._r8

if (L .eq. 1) then
 k_hobr_dep = r_hobr_dep
 POLL_CHBr3_L1 = POLL_CHBr3 * sea_multi
else
 k_hobr_dep = 0._r8
 POLL_CHBr3_L1 = 0._r8
end if
\end{lstlisting}


The photolysis rates of $\chem{HOBr}$, $\chem{BrO}$ and $\chem{CH_3Br}$ were already included in \texttt{ratj\_oc.d} and could be declared directly. The photolysis rates of \chem{BrCl} and $\chem{Br_2}$ were set constant as 0.1 as long as the photolysis rate of ozone was higher than 0 (i.e. daylight present)


\subsection{Halogen families}

The halogen chemistry were implemented using the method of families described in Section \ref{sec:families}. The $\chem{Br_y}$-family is the same as the that already was implemented in the CTM3 for the stratosphere, but the $\chem{Cl_x}$- and $\chem{Cl_y}$-families differ. 
 
\begin{align*}
    \chem{Br_y} &= \chem{Br} + \chem{BrO} + \chem{BrONO_2} + \chem{OHBr} + 2\chem{Br_2} + \chem{BrCl} \\
    \chem{Cl_x} &= \chem{Cl} + \chem{ClO} \\
    \chem{Cl_y} &= \chem{Cl_x} + \chem{HCl}
\end{align*}

An iterative scaling is applied before and after the QSSA-calculation



\subsubsection{Ozone loss}


The loss in $\chem{O_3}$ was added assuming a low-$\chem{NO_x}$ regime explained in Section \ref{sec:O3-NO}

\subsection{Changes in \texttt{tropchem\_oslo.f90}:}\label{sec:tropchem_oslo}

\texttt{tropchem\_oslo} is a module that drives the Oslo tropospheric chemistry. It contains only one subroutine, \texttt{oslochem\_trop}, which prepares and calls the integration routine for each column, i.e. from the bottom of the column up to \texttt{LMTROP(I,J)} (top of troposphere) for each \texttt{I,J} (or \texttt{II,JJ} (OpenMP block - I-MPBLKIB +1)). 

\medskip

In the \texttt{I}-direction, \texttt{I} loops from \texttt{MPBLKIB} to \texttt{MPBLKIE}, where \texttt{MPBLKIB} is the beginning of the longitude index in the main domain and \texttt{MPBLKIE} is the end of the longitude index in the main domain. \texttt{II} is: 

\begin{equation*}
    \text{II} = \text{I} - \text{MPBLKB} + 1
\end{equation*}

\medskip

The modification to the subroutine has led to the following: 


\subsubsection{Oceanic emissions of $\chem{CH_2Br_2}$ and $\chem{CHBr_3}$}\label{sec:impl_ocean_source}

The addition of an organic bromine ($\chem{CH_2Br_2}$ and $\chem{CHBr_3}$) source from the ocean and coastlines based on the findings of \cite{Liang2010} (see Figure \ref{fig:Liang2010}). For more information concerning the organic halogens and the use of Liangs emission inventory, see Section \ref{sec:oceanic_emissions}.

\medskip

The ocean or coast is determined by an if-test that finds the latitude (\texttt{YDGRD(J)}) according to the land types specified in Appendix \ref{app:CTM3} in Table \ref{tab:PLAND}. The symmetrical if-test covers the latitudinal bands 90$^o$S - 50$^o$S/90$^o$N - 50$^o$N, 50$^o$S - 10$^o$S/50$^o$N - 10$^o$N and 10$^o$S - 10$^o$N. 

\medskip

\texttt{POLL\_CHBr3} is the concentration of $\chem{CH_2Br_2}$ and $\chem{CHBr_3}$ in one location (grid box). The calculation is based on an emission inventory  (units: kgm$^{-2}$s$^{-1}$)and later converted to concentrations (in molecules cm$^-{3}$s$^{-1}$). \texttt{tropchem\_oslo} calls \texttt{OSLO\_CHEM} (explained in the section above), where \texttt{POLL\_CHBr3} is added to the first layer of the tropopause. The syntax can be seen below:


\begin{lstlisting}
 POLL_CHBr3 = 0._r8

 
 if (abs(YDGRD(J)) .gt. 50._r8) then
 !// Latitude bands 90S-50S/50N-90N
    if (PLAND(I,J) .eq. 0._r8) then   
    !//Open ocean (PLAND=0)
       POLL_CHBr3 = 0.05e-13_r8 * 1.13_r8
    elseif (PLAND(I,J) .gt. 0._r8 &
        .and. PLAND(I,J) .lt. 0.5_r8) then
        !//coast/islands
        POLL_CHBr3 = 0.3e-13_r8 * 1.13_r8
    end if

 elseif (abs(YDGRD(J)) .gt. 10._r8 .and. &
    abs(YDGRD(J)) .le. 50._r8) then 
!// Latitude bands 50S-10S/50N-10N
    if (PLAND(I,J) .eq. 0._r8) then   
    !//Open ocean (PLAND=0)
       POLL_CHBr3 = 0.15e-13_r8 * 1.13_r8
    elseif (PLAND(I,J) .gt. 0._r8 &
       .and. PLAND(I,J) .lt. 0.5_r8) then
    !//coast/islands
       POLL_CHBr3 = 0.9e-13_r8 * 1.13_r8
    end if

 elseif (abs(YDGRD(J)) .le. 10._r8) then
 !// Latitude bands 10S-10N
    if (PLAND(I,J) .eq. 0._r8) then   
    !//Open ocean (PLAND=0)
       POLL_CHBr3 = 0.7e-13_r8 * 1.13_r8
    elseif (PLAND(I,J) .gt. 0._r8  & 
        .and. PLAND(I,J) .lt. 0.5_r8) then
    !//coast/islands
       POLL_CHBr3 = 0.9e-13_r8 * 1.13_r8
    end if

end if !//(abs(YDGRD(J)) .gt. 50._r8) then 



  !//Converting from [kg/(m2*s)] to [molecules/(cm3*s)]

  Mol_CHBr3 = 252.73   !Molar mass of CHBr3, [g/mol]

  POLL_CHBr3 = (POLL_CHBr3 * 1e-3_r8 * AVOGNR) &
         / ( Mol_CHBr3  &
         * ( DV(1) / AREAXY(I,J) ) )

\end{lstlisting}

\subsubsection{Multiphase reactions}\label{sec:impl_multiphase_react}

Parameterization of \chem{HOBr}-deposition on sea ice (Reactions \ref{R:7} and \ref{R:8}). According to \cite{CAO}, the change in concentration of \chem{HOBr} depends on the deposition velocity, $v_d$, the boundary layer height, $L_{mix}$ and the total reactive surface area offered by the snow/ice surface, $\beta$ (described further in Section \ref{sec:het_chem}). 

\medskip 

In order to ensure that there is a sea ice surface that the heterogeneous reaction may occur upon, the meteorological variable \texttt{CI}(sea-ice cover) from \texttt{cmn\_met.f90} is applied. The \texttt{CI}-field takes on a value between 0 $\rightarrow$ no ice or 1 $\rightarrow$ full ice cover (\cite{SovdeManual}). Thus, the \chem{HOBr}-depostition is determined as follows: 

\begin{lstlisting}
r_hobr_dep = 0._r8

beta = 1.4      !Ratio (surface offered/flat area)
                !(1 or bigger)
Lmix = 200      !Height of stable BL, standard is 200 [m]
vd = 0.00605    !Deposition velocity for 
                !Lmix=200->vd = 0.00605 [m/s]

if (CI(I,J) .lt. 0.7_r8) then
 r_hobr_dep = 0._r8
elseif (CI(I,J) .gt. 0.7_r8) then
 r_hobr_dep = ( vd / Lmix ) * beta
end if
\end{lstlisting}

This is a simplification of the black carbon on sea ice-parameterization of Amund Søvde (module: \texttt{bcoc\_oslo.f90}, subroutine: \texttt{bcsnow\_seaice\_ij}). 

\medskip 

 
The pressure- and temperature dependent multiphase reactions occurring on aerosol surfaces, Reactions \ref{R:8} and \ref{R:13} are declared in this module, and the rate constants are calculated in the subroutine \texttt{TCRATE\_TP\_IJ\_TRP} (see Section \ref{sec:chem_oslo_rates}). 



\subsection{Changes in \texttt{chem\_oslo\_rates.f90}:}\label{sec:chem_oslo_rates}



\texttt{chem\_oslo\_rates} is a module that contains the chemical reaction rates for both the troposphere and the stratosphere. It contains several subroutines, and the modified ones are: 


\subsubsection{Temperature Dependent Reaction Rates}\label{sec:temp_depend_react_rates}

The constant- and the temperature dependent reaction rates for the troposphere and the stratosphere are found in the subroutine \texttt{TCRATE\_CONS2}. Some reactions were already declared in the stratosphere (by Amund Søvde, \cite{SovdeManual}), and therefore included in the troposphere. This applied to the bimolecular Reactions \ref{R:2} (for both chlorine and bromine),  \ref{R:4}, \ref{R:6}, \ref{R:17}, \ref{R:15}, \ref{R:16} and \ref{R:14}. Reaction \ref{R:10} was also added. The Arrhenius factor for these reactions were taken from \cite{JPL}. 

\medskip

An overview of the reactions and their reaction rates can be found in Table \ref{tab:2b_and_3b_reactions}. A description of bimolecular reaction chemistry can be read in Section \ref{sec:bimolecular_reactions}. 

\subsubsection{Temperature- and Pressure Dependent Reaction Rates}\label{sec:temp_press_dependent_react_rates}

The temperature- and pressure dependent reaction rates for the troposphere are calculated in the subroutine \texttt{TCRATE\_TP\_IJ\_TRP}. The Reactions \ref{R:9} and \ref{R:cl_ch4} were moved to this subroutine, from the stratosphere. Their reaction rates are calculated using the function \texttt{RATE3B} (see \cite{SovdeManual}) with values from \cite{JPL}. A description of 3-body reaction chemistry can be read in Section \ref{sec:3body_reactions}. An overview of the reactions and their reaction rates can be found in Table \ref{tab:2b_and_3b_reactions}. 

\medskip

The temperature- and pressure dependent heterogeneous reaction rates (Reactions \ref{R:8} and \ref{R:13}) were also calculated in this subroutine, using the method by \cite{CAO} (See Section \ref{sec:aerosol_react})




\subsection{Wet Deposition and Henry's law}\label{sec:henrys_law_ctm3}

The wet deposition parameters are listed in the table \texttt{savenging\_wet.dat} 

%\input{Chapter5_CTM3setup/rate_constant}

%\input{Chapter5_CTM3setup/2body_and_3body_reactions}